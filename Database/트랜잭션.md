# 트랜잭션

## 트랜잭션이란

- DBMS에서 데이터를 다루는 논리적인 작업의 단위
- DB에서 데이터를 다룰 때 장애가 일어난 경우 데이터를 복구하는 작업의 단위
- DB에서 여러 작업이 동시에 같은 데이터를 다룰 때 이 작업을 서로 분리하는 단위
- 트랜잭션은 전체가 수행되거나 또는 전혀 수행되지 않아야 한다.(All or Nothing)

## 트랜잭션의 ACID 성질

- 원자성(Atomicity)
  - All or Nothing의 성질으로 **트랜잭션이 원자처럼 더 이상 쪼개지지 않는 하나의 프로그램 단위로 동작해야 한다는 의미**이다.
  - 즉, 트랜잭션에 포함된 작업은 전부 수행되거나 전부 수행되지 않아야 한다.
- 일관성(Consistency)
  - **트랜잭션을 수행하기 전과 후 모두, 데이터베이스는 항상 일관된 상태를 유지**해야 한다.
  - 예를 들어 어떤 테이블의 기본키 속성은 유지되어야 한다는 것, A에서 B로 돈을 이체할 때 A와 B 계좌의 돈의 총합은 같아야 한다는 것 등이 있다.
- 고립성(Isolation)
  - 수행 중인 트랜잭션에 다른 트랜잭션이 끼어들어 변경 중인 데이터 값을 훼손하지 않아야 한다.
  - 데이터베이스는 클라이언트들이 같은 데이터를 공유하는 것이 목적이므로 여러 트랜잭션이 동시에 수행되어야 한다. 이때 **트랜잭션은 상호 간의 존재를 모르고 독립적으로 수행**되어야 한다.
  - 이를 유지하기 위해 여러 트랜잭션이 **동시에 접근하는 데이터에 대한 제어가 필요**하다.
- 지속성(Durability)
  - 수행을 성공적으로 완료한 트랜잭션은 변경한 데이터를 영구히 저장해야 한다.
  - **트랜잭션의 성공 결과 값은 장애가 발생한 후에도 변함없이 보관되어야 한다.**
  - 정상적으로 완료 혹은 부분완료된 데이터는 DBMS가 책임지고 데이터베이스에 기록하는 성질.

## 트랜잭션과 DBMS

- DBMS는 원자성을 유지하기 위해 회복(복구) 관리자 프로그램을 이용한다.
- DBMS는 일관성을 유지하기 위해 동시성 제어 알고리즘과 무결성 제약조건을 활용한다.
- DBMS는 고립성을 유지하기 위해 동시성 제어 알고리즘을 작동시킨다.
- DBMS는 지속성을 유지하기 위해 회복 관리자 프로그램을 이용한다.
  ![image](https://user-images.githubusercontent.com/47625368/122631881-f9c0b900-d109-11eb-9e11-06612d057c1c.png)

어떤 트랜잭션이 실행되다가 장애에 의해 부분 완료되는 상황은 원자성과 지속성이라는 속성에 위배된다. 그래서 DBMS는 이를 유지하기 위해 **회복 관리자 프로그램**을 이용한다. 일부만 진행된 트랜잭션을 취소시켜 원자성을 유지할 뿐만 아니라 값을 트랜잭션 이전의 상태로 복원시켜 지속성을 유지시킨다.

또한, 값에 동시에 접근하지 않도록 **동시성 제어**를 활용하여 일관성과 고립성을 유지시킨다. 여기에 더해 DBMS는 잘못된 값에 대한 입력이 들어오면 일관성이 무너질 수 있으므로 이를 유지하기 위해 **무결성 제약조건**도 활용한다.

## 트랜잭션 상태

![image](https://user-images.githubusercontent.com/47625368/122632203-42797180-d10c-11eb-80e0-d44caada5674.png)

- 활동(active)
  - 트랜잭션이 Begin_transaction으로부터 실행을 시작했거나 실행 중인 상태.
- 부분 완료(partially committed)
  - 마지막 명령문을 실행시킨 직후의 상태를 의미하며 실패(failed) 또는 완료(committed)의 상태로 전이하게 된다.
- 실패(failed)
  - 트랜잭션 실행 중 장애나 오류가 발생하여 정상적인 실행을 더이상 할 수 없는 상태.
  - Rollback 연산을 수행한 후 철회(aborted) 상태로 전이하게 된다.
- 철회(aborted)
  - Rollback 연산을 수행한 상태(트랜잭션 재시작 or 강제종료)
  - 트랜잭션 철회의 원인이 **트랜잭션 내부의 논리적인 오류에 의해 오류를 수정해야 하는 상황이거나, 얻고자 하는 데이터가 DB에 존재하지 않는 경우**에는 **강제 종료**.
  - 철회의 원인이 **트랜잭션 내부의 논리적인 오류가 아닌 경우**에는 **재시작**.

### 참고자료

- https://mangkyu.tistory.com/30?category=761304
